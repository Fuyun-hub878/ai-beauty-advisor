import streamlit as st
import pandas as pd
import numpy as np
import sqlite3
import cv2
from sklearn.metrics.pairwise import cosine_similarity
import random
from datetime import datetime

st.set_page_config(page_title="AIç¾å¦†é¡¾é—® Pro", page_icon="ğŸ’„", layout="wide")
st.title("ğŸ’„ AIç¾å¦†é¡¾é—® Pro")
st.caption("ä»MVPæ¼”ç¤ºç‰ˆå‡çº§ä¸ºåŒ…å«çœŸå®æ‘„åƒå¤´åˆ†æã€æ•°æ®åº“ä¸AIæ¨èçš„å®Œæ•´ç³»ç»ŸåŸå‹")

# ---------- æ¨¡å—1: æ¨¡æ‹Ÿæ•°æ®åº“ï¼ˆå°†è¢«æ›¿æ¢ï¼‰ ----------
class MockProductDB:
    def __init__(self):
        self.products = pd.DataFrame([
            {"id": 1, "name": "CeraVeæ³¡æ²«æ´é¢", "category": "cleanser", "skin_type": "all", "key_ingredients": "Ceramides, Hyaluronic Acid", "allergens": "", "price_tier": "affordable"},
            {"id": 2, "name": "The OrdinaryçƒŸé…°èƒºç²¾å", "category": "serum", "skin_type": "oily", "key_ingredients": "Niacinamide, Zinc PCA", "allergens": "", "price_tier": "affordable"},
            {"id": 3, "name": "La Roche-Posayä¿æ¹¿éœœ", "category": "moisturizer", "skin_type": "dry", "key_ingredients": "Ceramides, Thermal Water", "allergens": "", "price_tier": "premium"},
            {"id": 4, "name": "å®‰çƒ­æ²™é˜²æ™’éœœ", "category": "sunscreen", "skin_type": "all", "key_ingredients": "Zinc Oxide, Vitamin E", "allergens": "Alcohol", "price_tier": "premium"},
            {"id": 5, "name": "SK-IIç¥ä»™æ°´", "category": "essence", "skin_type": "all", "key_ingredients": "Pitera", "allergens": "", "price_tier": "luxury"},
        ])
    def get_all_products(self):
        return self.products
    def get_products_by_skin_type(self, skin_type):
        return self.products[(self.products['skin_type']==skin_type) | (self.products['skin_type']=='all')]

# ---------- æ¨¡å—2: æ¨¡æ‹Ÿæ¨èå¼•æ“ï¼ˆå°†è¢«æ›¿æ¢ï¼‰ ----------
class MockRecommendationEngine:
    def recommend(self, user_profile, all_products):
        num = min(3, len(all_products))
        return all_products.sample(n=num)

# ---------- æ¨¡å—3: æ¨¡æ‹Ÿçš®è‚¤åˆ†æï¼ˆå°†è¢«æ›¿æ¢ï¼‰ ----------
class MockSkinAnalyzer:
    def analyze_from_camera(self):
        return {
            'skin_type': random.choice(['dry', 'oily', 'combination']),
            'moisture': random.randint(30, 90),
            'oiliness': random.randint(20, 80),
            'primary_concern': random.choice(['pores', 'hydration', 'evenness']),
            'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }

@st.cache_resource
def init_components():
    return {
        'db': MockProductDB(),
        'recommender': MockRecommendationEngine(),
        'analyzer': MockSkinAnalyzer()
    }

components = init_components()
db = components['db']
recommender = components['recommender']
analyzer = components['analyzer']

with st.sidebar:
    st.header("âš™ï¸ ç³»ç»Ÿæ§åˆ¶é¢æ¿")
    st.subheader("ğŸš€ æ¨¡å—å‡çº§å¼€å…³")
    use_real_database = st.checkbox("å¯ç”¨çœŸå®æ•°æ®åº“æ¨¡å—ï¼ˆé˜¶æ®µä¸€ï¼‰", value=False)
    use_real_recommender = st.checkbox("å¯ç”¨AIæ¨èå¼•æ“æ¨¡å—ï¼ˆé˜¶æ®µäºŒï¼‰", value=False)
    use_real_camera = st.checkbox("å¯ç”¨çœŸå®æ‘„åƒå¤´åˆ†ææ¨¡å—ï¼ˆé˜¶æ®µä¸‰ï¼‰", value=False)
    st.divider()
    st.subheader("ğŸ‘¤ ç”¨æˆ·è®¾ç½®")
    user_name = st.text_input("ä½ çš„åå­—", "Alex")
    known_allergens = st.multiselect("å·²çŸ¥è¿‡æ•åŸ", ["é¦™ç²¾/Fragrance", "é…’ç²¾/Alcohol", "é˜²è…å‰‚/Parabens", "çŸ¿ç‰©æ²¹/Mineral Oil"])
    st.divider()
    st.info("**æ¼”ä¹ è¯´æ˜**ï¼š\n1. å½“å‰æ‰€æœ‰æ¨¡å—å‡ä¸ºæ¨¡æ‹ŸçŠ¶æ€ã€‚\n2. å‹¾é€‰ä¸Šæ–¹å¼€å…³ä»¥â€˜å¯ç”¨â€™å‡çº§åçš„æ¨¡å—ã€‚\n3. æ¯æ¬¡å‹¾é€‰éƒ½å¯¹åº”ä¸€æ¬¡çœŸå®çš„ä»£ç å‡çº§ã€‚")
tab1, tab2, tab3 = st.tabs(["ğŸ” çš®è‚¤åˆ†æ", "ğŸ“¦ äº§å“æ¨è", "âš™ï¸ ç³»ç»ŸçŠ¶æ€"])

with tab1:
    st.subheader("é¢éƒ¨çš®è‚¤åˆ†æ")
    col1, col2 = st.columns(2)
    with col1:
        if use_real_camera:
            st.warning("**çœŸå®æ‘„åƒå¤´æ¨¡å—å¾…å®ç°**")
            st.write("æ­¤å¤„å°†é›†æˆ `streamlit-webrtc` å’Œ `MediaPipe` æ¨¡å‹ã€‚")
            if st.button("æ¨¡æ‹ŸçœŸå®åˆ†æè¿‡ç¨‹", type="primary"):
                with st.spinner("æ­£åœ¨è°ƒç”¨åˆ†ææ¨¡å‹..."):
                    analysis_result = analyzer.analyze_from_camera()
                    st.session_state['skin_analysis'] = analysis_result
                    st.success("åˆ†æå®Œæˆï¼")
        else:
            st.info("**å½“å‰ï¼šæ¨¡æ‹Ÿåˆ†ææ¨¡å¼**")
            if st.button("å¼€å§‹æ¨¡æ‹Ÿåˆ†æ", type="primary"):
                analysis_result = analyzer.analyze_from_camera()
                st.session_state['skin_analysis'] = analysis_result
                st.success("æ¨¡æ‹Ÿåˆ†æå®Œæˆï¼")
        if 'skin_analysis' in st.session_state:
            result = st.session_state['skin_analysis']
            st.metric("æ£€æµ‹è‚¤è´¨", result['skin_type'].upper())
            st.metric("æ°´åˆ†å€¼", f"{result['moisture']}/100")
            st.metric("æ²¹è„‚å€¼", f"{result['oiliness']}/100")
            st.metric("ä¸»è¦é—®é¢˜", result['primary_concern'])
    with col2:
        st.subheader("åˆ†æè¯´æ˜")
        st.markdown("""
        **ğŸ¯ æ¨¡å—å‡çº§è·¯å¾„ï¼š**
        1. **æ¨¡æ‹Ÿåˆ†æ** â†’ **çœŸå®æ‘„åƒå¤´åˆ†æ**
        2. **å…³é”®æŠ€æœ¯ç‚¹**ï¼š
           - ä½¿ç”¨ `streamlit-webrtc` è·å–å®æ—¶è§†é¢‘æµ
           - ä½¿ç”¨ `MediaPipe Face Mesh` æ£€æµ‹äººè„¸åŒºåŸŸ
           - æå–ROIè¿›è¡Œçš®è‚¤çº¹ç†ã€é¢œè‰²åˆ†æ
        """)

with tab2:
    st.subheader("ä¸ªæ€§åŒ–äº§å“æ¨è")
    if 'skin_analysis' not in st.session_state:
        st.info("è¯·å…ˆåœ¨ã€çš®è‚¤åˆ†æã€‘æ ‡ç­¾é¡µå®Œæˆåˆ†æã€‚")
        st.stop()
    user_skin_type = st.session_state['skin_analysis']['skin_type']
    if use_real_database:
        st.warning("**çœŸå®æ•°æ®åº“æ¨¡å—å¾…å®ç°**")
        st.write("æ­¤å¤„å°†ä»SQLiteæ•°æ®åº“ä¸­å®æ—¶æŸ¥è¯¢äº§å“æ•°æ®ã€‚")
        products = db.get_all_products()
    else:
        products = db.get_products_by_skin_type(user_skin_type)
    if use_real_recommender:
        st.warning("**AIæ¨èå¼•æ“æ¨¡å—å¾…å®ç°**")
        st.write("æ­¤å¤„å°†ä½¿ç”¨åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„AIç®—æ³•è¿›è¡Œæ¨èã€‚")
        recommendations = db.get_all_products().sample(n=3)
    else:
        recommendations = recommender.recommend(
            {'skin_type': user_skin_type, 'allergens': known_allergens},
            products
        )
    st.success(f"æ ¹æ®ä½ çš„ **{user_skin_type}** è‚¤è´¨ï¼Œä¸ºä½ æ¨èä»¥ä¸‹äº§å“ï¼š")
    for idx, row in recommendations.iterrows():
        with st.container(border=True):
            cols = st.columns([3, 1])
            with cols[0]:
                st.markdown(f"**{row['name']}**")
                st.caption(f"å“ç±»ï¼š{row['category']} | è‚¤è´¨ï¼š{row['skin_type']} | ä»·æ ¼æ¡£ä½ï¼š{row['price_tier']}")
                st.write(f"æ ¸å¿ƒæˆåˆ†ï¼š{row['key_ingredients']}")
                if row['allergens']:
                    st.warning(f"æ³¨æ„ï¼šå« {row['allergens']}")
            with cols[1]:
                if st.button("é€‰æ‹©", key=f"select_{row['id']}"):
                    st.session_state['last_selected'] = row['name']
                    st.rerun()
    if 'last_selected' in st.session_state:
        st.toast(f"å·²æ·»åŠ  '{st.session_state['last_selected']}' åˆ°æ‚¨çš„æ¸…å•ï¼")

with tab3:
    st.subheader("ç³»ç»Ÿæ¨¡å—çŠ¶æ€")
    status_data = {
        "æ¨¡å—åç§°": ["æ•°æ®åº“æ¨¡å—", "æ¨èå¼•æ“æ¨¡å—", "æ‘„åƒå¤´åˆ†ææ¨¡å—"],
        "å½“å‰ç‰ˆæœ¬": ["æ¨¡æ‹Ÿç‰ˆæœ¬", "æ¨¡æ‹Ÿç‰ˆæœ¬", "æ¨¡æ‹Ÿç‰ˆæœ¬"],
        "å‡çº§ç›®æ ‡": ["SQLiteæ•°æ®åº“", "AIå‘é‡æ¨è", "MediaPipeåˆ†æ"],
        "çŠ¶æ€": ["å¾…å‡çº§" if not use_real_database else "å‡çº§ä¸­",
                "å¾…å‡çº§" if not use_real_recommender else "å‡çº§ä¸­",
                "å¾…å‡çº§" if not use_real_camera else "å‡çº§ä¸­"]
    }
    st.table(pd.DataFrame(status_data))
    st.divider()
    st.subheader("ğŸ“š ä¸‹ä¸€æ­¥å‡çº§æŒ‡å—")
    st.markdown("""
    1. **é˜¶æ®µä¸€ï¼šå®ç°çœŸå®æ•°æ®åº“**
       - åˆ›å»º `cosmetics.db` SQLiteæ•°æ®åº“
       - åˆ›å»º `RealProductDB` ç±»æ›¿æ¢ `MockProductDB`
    2. **é˜¶æ®µäºŒï¼šå®ç°AIæ¨èå¼•æ“**
       - å®ç°åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„æ¨èç®—æ³•
    3. **é˜¶æ®µä¸‰ï¼šå®ç°çœŸå®æ‘„åƒå¤´åˆ†æ**
       - å®‰è£… `streamlit-webrtc` å’Œ `mediapipe`
    """)
    if st.button("ğŸš€ ç«‹å³å¼€å§‹ç¬¬ä¸€é˜¶æ®µå‡çº§", type="primary"):
        st.info("æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç”¨çœŸå®SQLiteæ•°æ®åº“æ›¿æ¢æ¨¡æ‹Ÿæ•°æ®åº“ï¼")

if __name__ == "__main__":
    st.sidebar.divider()
    st.sidebar.caption(f"ç³»ç»Ÿç‰ˆæœ¬ï¼šMVP â†’ Pro | æœ€åæ›´æ–°ï¼š{datetime.now().strftime('%Y-%m-%d')}")
